name: ğŸ™ï¸ Generate Podcast

on:
  # Manual trigger with script input
  workflow_dispatch:
    inputs:
      script_content:
        description: 'Podcast script content (paste your script here)'
        required: true
        type: string
      notification_email:
        description: 'Email for notification (optional, uses default if empty)'
        required: false
        type: string
        default: ''
  
  # Automatic trigger on script.txt changes
  push:
    paths:
      - 'script.txt'
    branches:
      - main
  
  # API webhook trigger for external systems
  repository_dispatch:
    types: [generate_podcast]

jobs:
  generate:
    name: Generate Podcast Audio
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“ Prepare script (manual trigger)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.script_content != ''
        run: |
          echo "${{ github.event.inputs.script_content }}" > script.txt
          echo "âœ… Script content written from manual input"
      
      - name: ğŸ“ Prepare script (API trigger)
        if: github.event_name == 'repository_dispatch'
        run: |
          echo '${{ github.event.client_payload.script }}' > script.txt
          echo "âœ… Script content written from API payload"
      
      - name: ğŸ” Validate script
        run: |
          if [ ! -f script.txt ]; then
            echo "âŒ Error: script.txt not found"
            exit 1
          fi
          
          SCRIPT_SIZE=$(wc -c < script.txt)
          echo "ğŸ“Š Script size: $SCRIPT_SIZE bytes"
          
          if [ $SCRIPT_SIZE -lt 100 ]; then
            echo "âš ï¸ Warning: Script seems too short (< 100 bytes)"
          fi
          
          echo "âœ… Script validation passed"
      
      - name: ğŸ™ï¸ Generate podcast
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ Starting podcast generation..."
          python IVSC_Podcast_German_flash.py
          
          if [ -f "Podcast_Audio_full.wav" ]; then
            FILE_SIZE=$(ls -lh Podcast_Audio_full.wav | awk '{print $5}')
            echo "âœ… Podcast generated successfully! Size: $FILE_SIZE"
          else
            echo "âŒ Error: Podcast file not generated"
            exit 1
          fi
      
      - name: ğŸ“Š Generate metadata
        id: metadata
        run: |
          # Count chunks
          CHUNK_COUNT=$(ls Podcast_Audio_*.wav 2>/dev/null | grep -v "full" | wc -l)
          echo "chunk_count=$CHUNK_COUNT" >> $GITHUB_OUTPUT
          
          # Get file size
          FILE_SIZE=$(ls -lh Podcast_Audio_full.wav | awk '{print $5}')
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
          
          # Estimate duration (assuming 24kHz, 16-bit, mono)
          BYTES=$(wc -c < Podcast_Audio_full.wav)
          DURATION_SEC=$((($BYTES - 44) / 48000))
          DURATION_MIN=$(($DURATION_SEC / 60))
          echo "duration_min=$DURATION_MIN" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Metadata collected:"
          echo "  - Chunks: $CHUNK_COUNT"
          echo "  - Size: $FILE_SIZE"
          echo "  - Duration: ~$DURATION_MIN minutes"
      
      - name: ğŸ“¤ Upload podcast to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: podcast-${{ github.run_number }}
          path: Podcast_Audio_full.wav
          retention-days: 30
          compression-level: 0  # WAV already compressed
      
      - name: ğŸ“¦ Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: podcast-${{ github.run_number }}
          name: Podcast Episode ${{ github.run_number }}
          body: |
            # ğŸ™ï¸ Podcast Episode ${{ github.run_number }}
            
            **Generated**: ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
            **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ## ğŸ“Š Statistics
            - **Chunks**: ${{ steps.metadata.outputs.chunk_count }}
            - **File Size**: ${{ steps.metadata.outputs.file_size }}
            - **Duration**: ~${{ steps.metadata.outputs.duration_min }} minutes
            - **Model**: Gemini 2.5 Flash TTS
            - **Voices**: Sulafat & Sadachbia
            
            ## ğŸ”— Download
            Click the asset below to download the complete podcast.
            
            ---
            *Generated automatically by RP AI Podcast Generator*
          files: Podcast_Audio_full.wav
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ï¿½ Post success comment (GitHub Notification)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const runNumber = context.runNumber;
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const releaseUrl = `${{ github.server_url }}/${{ github.repository }}/releases/tag/podcast-${runNumber}`;
            const downloadUrl = `${{ github.server_url }}/${{ github.repository }}/releases/download/podcast-${runNumber}/Podcast_Audio_full.wav`;
            
            const body = `## ğŸ™ï¸ Podcast Episode ${runNumber} Generated Successfully!
            
            ### ğŸ“Š Statistics
            - **Chunks**: ${{ steps.metadata.outputs.chunk_count }}
            - **Duration**: ~${{ steps.metadata.outputs.duration_min }} minutes
            - **File Size**: ${{ steps.metadata.outputs.file_size }}
            - **Model**: Gemini 2.5 Flash TTS
            - **Voices**: Sulafat & Sadachbia
            
            ### ğŸ”— Download
            **[ğŸ“¥ Download Podcast](${downloadUrl})**
            
            ### ğŸ“‹ Links
            - [ğŸ“¦ Release Page](${releaseUrl})
            - [ğŸ“Š Workflow Run](${runUrl})
            
            ---
            *Generated automatically by RP AI Podcast Generator*`;
            
            // Create issue for notification
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âœ… Podcast #${runNumber} Ready - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['podcast-ready', 'automated']
            });
      
      - name: ğŸ“§ Send email notification (fallback)
        if: success() && secrets.SMTP_HOST != ''
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: âœ… Podcast Generated Successfully - Episode ${{ github.run_number }}
          to: ${{ github.event.inputs.notification_email || github.event.client_payload.email || secrets.NOTIFICATION_EMAIL }}
          from: RP AI Podcast Generator <${{ secrets.SMTP_USER }}>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
                .stats { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
                .stat-item { display: inline-block; margin: 10px 20px; }
                .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
                .stat-value { font-size: 24px; font-weight: bold; color: #667eea; }
                .button { display: inline-block; background: #667eea; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; margin: 10px 5px; }
                .button:hover { background: #5568d3; }
                .footer { text-align: center; color: #666; font-size: 12px; margin-top: 30px; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1>ğŸ™ï¸ Podcast Generated!</h1>
                  <p>Your podcast episode is ready to download</p>
                </div>
                
                <div class="content">
                  <h2>Episode ${{ github.run_number }}</h2>
                  
                  <div class="stats">
                    <div class="stat-item">
                      <div class="stat-label">Chunks</div>
                      <div class="stat-value">${{ steps.metadata.outputs.chunk_count }}</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Duration</div>
                      <div class="stat-value">~${{ steps.metadata.outputs.duration_min }} min</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Size</div>
                      <div class="stat-value">${{ steps.metadata.outputs.file_size }}</div>
                    </div>
                  </div>
                  
                  <h3>ğŸ”— Download Options</h3>
                  <p>
                    <a href="${{ github.server_url }}/${{ github.repository }}/releases/download/podcast-${{ github.run_number }}/Podcast_Audio_full.wav" class="button">
                      ğŸ“¥ Download Podcast
                    </a>
                    <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="button">
                      ğŸ“Š View Details
                    </a>
                  </p>
                  
                  <h3>â„¹ï¸ Technical Details</h3>
                  <ul>
                    <li><strong>Model:</strong> Gemini 2.5 Flash TTS</li>
                    <li><strong>Voices:</strong> Sulafat (Speaker 1) & Sadachbia (Speaker 2)</li>
                    <li><strong>Format:</strong> WAV, 24kHz, 16-bit, Mono</li>
                    <li><strong>Generated:</strong> ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}</li>
                  </ul>
                  
                  <p><small>ğŸ’¡ The download link is valid for 90 days. Artifacts are available for 30 days.</small></p>
                  
                  <div class="footer">
                    <p>Generated by <strong>RP AI Podcast Generator</strong></p>
                    <p>Repository: <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></p>
                  </div>
                </div>
              </div>
            </body>
            </html>
      
      - name: ğŸ§¹ Cleanup temporary files
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          rm -f Podcast_Audio_*.wav 2>/dev/null || true
          rm -f ff_concat_list.txt 2>/dev/null || true
          rm -rf __pycache__/ 2>/dev/null || true
          echo "âœ… Cleanup complete"
      
      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo "## ğŸ™ï¸ Podcast Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Episode**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Chunks**: ${{ steps.metadata.outputs.chunk_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ~${{ steps.metadata.outputs.duration_min }} minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **File Size**: ${{ steps.metadata.outputs.file_size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Download" >> $GITHUB_STEP_SUMMARY
          echo "[Release Page](${{ github.server_url }}/${{ github.repository }}/releases/tag/podcast-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
